let goalTime = 45;
let startTime;
let timerInterval;
let watchID;
let lastPosition = null;
let totalDistance = 0;
let pace = 0;
let distanceMeters = 0;

const roadContainer = document.getElementById("roadContainer");
const pacerDot = document.getElementById("pacerDot");
const userIcon = document.getElementById("userIcon");
const centerLine = document.getElementById("centerLine");

function formatTime(seconds) {
  const m = Math.floor(seconds / 60).toString().padStart(2, '0');
  const s = Math.floor(seconds % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

function startRoadTest() {
  goalTime = parseFloat(document.getElementById("goalTime").value);
  startTime = Date.now();
  totalDistance = 0;
  distanceMeters = 0;
  lastPosition = null;

  updateDottedLine(); // reset line to top
  centerLine.style.height = "200%"; // keep it longer than container

  if (navigator.geolocation) {
    watchID = navigator.geolocation.watchPosition(gpsSuccess, gpsError, {
      enableHighAccuracy: true,
      maximumAge: 1000,
      timeout: 5000
    });
  }

  timerInterval = setInterval(updateTimer, 1000);
}

function stopTest() {
  clearInterval(timerInterval);
  if (watchID) navigator.geolocation.clearWatch(watchID);
}

function gpsSuccess(position) {
  const current = position.coords;
  const now = Date.now();

  if (lastPosition) {
    const dist = calculateDistance(
      lastPosition.latitude, lastPosition.longitude,
      current.latitude, current.longitude
    );
    const distMeters = dist * 1609.34;
    distanceMeters += distMeters;
    totalDistance += dist;

    const timeElapsed = (now - lastPosition.timestamp) / 1000;
    pace = (dist / (timeElapsed / 3600)); // mph

    updateStats();
    updatePacerDot();
    updateDottedLine();

    const percent = Math.min((totalDistance / 3) * 100, 100);
    document.getElementById("distanceFill").style.width = `${percent}%`;

    if (pace > 0) {
      const milesLeft = 3 - totalDistance;
      const finishTime = new Date(now + (milesLeft / pace) * 3600000);
      document.getElementById("estFinish").textContent =
        finishTime.getMinutes() > 50 ? "Est Finish: >50" :
        "Est Finish: " + finishTime.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
    } else {
      document.getElementById("estFinish").textContent = "Est Finish: --";
    }
  }

  lastPosition = {
    latitude: current.latitude,
    longitude: current.longitude,
    timestamp: now
  };
}

function gpsError(err) {
  console.error("GPS error:", err);
}

function calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI / 180) *
            Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c * 0.621371; // miles
}

function updateTimer() {
  const elapsed = (Date.now() - startTime) / 1000;
  updatePacerDot();
}

function updatePacerDot() {
  const containerHeight = roadContainer.offsetHeight;
  const elapsed = (Date.now() - startTime) / 1000;

  const pacerDistance = (elapsed / (goalTime * 60)) * 3; // miles
  const distanceGap = totalDistance - pacerDistance;

  // Place pacer relative to user
  const yOffset = distanceGap * containerHeight / 3;
  const topPercent = 50 - (yOffset / containerHeight) * 100;
  pacerDot.style.top = `${topPercent}%`;
}

function updateDottedLine() {
  // Each 3 meters = shift 30px downward
  const shift = -(distanceMeters / 3) * 30;
  centerLine.style.top = `${shift}px`;
}

function updateStats() {
  document.getElementById("pace").textContent = `Speed: ${pace.toFixed(2)} mph`;
  document.getElementById("distance").textContent = `Distance: ${totalDistance.toFixed(2)} mi`;
}
