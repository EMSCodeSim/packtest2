<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pack Test Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .track-container {
      position: relative;
      width: 90vw;
      height: 70vh;
      margin-top: 20px;
      background: #e0e0e0;
      border-radius: 200px / 100px;
      overflow: hidden;
    }
    .runner, .pacer {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .runner {
      background-color: yellow;
    }
    .pacer {
      background-color: green;
    }
    .info {
      margin-top: 20px;
      text-align: center;
    }
    .inputs {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .progress-bar {
      width: 90vw;
      height: 20px;
      background: #ccc;
      margin-top: 10px;
      position: relative;
    }
    .progress {
      height: 100%;
      background: #4caf50;
      width: 0%;
    }
  </style>
</head>
<body>
  <div class="track-container">
    <div id="runner" class="runner"></div>
    <div id="pacer" class="pacer"></div>
  </div>
  <div class="info">
    <div id="distance">Distance: 0.00 mi</div>
    <div id="laps">Laps: 0</div>
    <div id="pace">Pace: 0 mph / 0.00 min/lap</div>
    <div id="estFinish">Est. Finish: 0 min</div>
    <div class="inputs">
      <input id="lapsPerMile" type="number" value="4" size="2" /> Laps/Mile
      <input id="goalTime" type="number" value="45" size="2" /> Goal (min)
      <button onclick="startTracking()">Start</button>
    </div>
  </div>
  <div class="progress-bar">
    <div id="progress" class="progress"></div>
  </div>

  <script>
    let watchID;
    let startTime;
    let totalDistance = 0;
    let prevCoords = null;
    let laps = 0;

    const runner = document.getElementById('runner');
    const pacer = document.getElementById('pacer');
    const distanceDisplay = document.getElementById('distance');
    const lapsDisplay = document.getElementById('laps');
    const paceDisplay = document.getElementById('pace');
    const estDisplay = document.getElementById('estFinish');
    const progress = document.getElementById('progress');

    function startTracking() {
      startTime = Date.now();
      totalDistance = 0;
      laps = 0;
      prevCoords = null;

      if (navigator.geolocation) {
        watchID = navigator.geolocation.watchPosition(updatePosition, showError, {
          enableHighAccuracy: true,
          maximumAge: 1000
        });
      } else {
        alert('Geolocation is not supported by this browser.');
      }
      animatePacer();
    }

    function updatePosition(position) {
      const { latitude, longitude } = position.coords;
      if (prevCoords) {
        const dist = calcDistance(latitude, longitude, prevCoords.latitude, prevCoords.longitude);
        totalDistance += dist;
        const lapsPerMile = parseFloat(document.getElementById('lapsPerMile').value);
        const lapDistance = 1 / lapsPerMile;
        laps = Math.floor(totalDistance / lapDistance);
        const elapsedTime = (Date.now() - startTime) / 1000 / 60;
        const mph = totalDistance / (elapsedTime / 60);
        const pacePerLap = (elapsedTime / laps).toFixed(2);

        distanceDisplay.textContent = `Distance: ${totalDistance.toFixed(2)} mi`;
        lapsDisplay.textContent = `Laps: ${laps}`;
        paceDisplay.textContent = `Pace: ${mph.toFixed(2)} mph / ${isNaN(pacePerLap) ? '0.00' : pacePerLap} min/lap`;

        const goal = parseFloat(document.getElementById('goalTime').value);
        let est = (goal * totalDistance) / (totalDistance || 1);
        if (est > 50) estDisplay.textContent = 'Est. Finish: >50 min';
        else estDisplay.textContent = `Est. Finish: ${Math.round(est)} min`;

        let progressPercent = (totalDistance / 3) * 100;
        if (progressPercent > 100) progressPercent = 100;
        progress.style.width = progressPercent + '%';

        moveRunnerIcon(elapsedTime);
      }
      prevCoords = { latitude, longitude };
    }

    function moveRunnerIcon(t) {
      const angle = (t * 20) % 360; // Simulated movement speed
      const rad = angle * (Math.PI / 180);
      const radiusX = 180;
      const radiusY = 90;
      const centerX = 0.45 * window.innerWidth;
      const centerY = 0.35 * window.innerHeight;
      const x = centerX + radiusX * Math.cos(rad);
      const y = centerY + radiusY * Math.sin(rad);
      runner.style.left = x + 'px';
      runner.style.top = y + 'px';
    }

    function animatePacer() {
      const goal = parseFloat(document.getElementById('goalTime').value);
      const lapsPerMile = parseFloat(document.getElementById('lapsPerMile').value);
      const totalLaps = 3 * lapsPerMile;
      const duration = goal * 60 * 1000; // total time in ms
      const start = Date.now();

      function frame() {
        const elapsed = Date.now() - start;
        const percent = elapsed / duration;
        const angle = (percent * 360 * totalLaps) % 360;
        const rad = angle * (Math.PI / 180);
        const radiusX = 180;
        const radiusY = 90;
        const centerX = 0.45 * window.innerWidth;
        const centerY = 0.35 * window.innerHeight;
        const x = centerX + radiusX * Math.cos(rad);
        const y = centerY + radiusY * Math.sin(rad);
        pacer.style.left = x + 'px';
        pacer.style.top = y + 'px';
        requestAnimationFrame(frame);
      }
      frame();
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 3958.8; // Radius of the Earth in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function showError(error) {
      alert('GPS Error: ' + error.message);
    }
  </script>
</body>
</html>
