<!DOCTYPE html>
<html>
<head>
  <title>Track Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: white;
      overflow: hidden;
    }
    #trackContainer {
      position: relative;
      width: 100%;
      height: 80vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #track {
      position: relative;
      width: 90%;
      aspect-ratio: 2/3;
      border: 6px solid #ccc;
      border-radius: 50% / 40%;
      box-sizing: border-box;
      background: #222;
    }
    .dot, .walker {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    .dot { background: lime; }
    .walker { background: yellow; }

    #trackInfo {
      position: absolute;
      top: 30px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
    }

    #trackInfo input {
      width: 40px;
      font-size: 14px;
      padding: 2px 4px;
      margin: 4px;
      text-align: center;
    }
    #trackInfo button {
      padding: 8px 16px;
      font-size: 16px;
      margin-top: 10px;
      margin-right: 5px;
    }

    #lapCount {
      text-align: center;
      margin-top: 5px;
      font-size: 18px;
    }

    #progressBar {
      height: 10px;
      background: #555;
      width: 100%;
      margin-top: 6px;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: lime;
      width: 0%;
    }
  </style>
</head>
<body>
  <div id="trackContainer">
    <div id="track">
      <div class="dot" id="pacerDot"></div>
      <div class="walker" id="walkerIcon"></div>
      <div id="trackInfo">
        <label>üö∂ <input type="number" id="lapsPerMile"> laps/mile</label><br>
        <label>‚è±Ô∏è <input type="number" id="goalTime"> min</label><br>
        <button onclick="toggleRoad()">Road Mode</button>
        <button onclick="startStop()">Start</button>
        <div id="lapCount">Lap: 0 / 12</div>
        <div id="stats">Time: 0:00 | Pace: 0.00 mph | Est. Finish: 0:00</div>
      </div>
    </div>
  </div>

  <div id="progressBar"><div class="progress-fill" id="progressFill"></div></div>

  <script>
    let startTime, timerInterval;
    let elapsedSeconds = 0;
    const statsDisplay = document.getElementById("stats");
    let lastPosition = null;
    let totalDistance = 0; // in meters
    const METERS_IN_MILE = 1609.34;

    window.onload = function () {
      document.getElementById('lapsPerMile').value = localStorage.getItem('lapsPerMile') || 4;
      document.getElementById('goalTime').value = localStorage.getItem('goalTime') || 45;
    };

    function toggleRoad() {
      window.location.href = "road.html";
    }

    function startStop() {
      if (!timerInterval) {
        startTime = Date.now();
        timerInterval = setInterval(updateTimer, 1000);
        navigator.geolocation.watchPosition(updateLocation, null, { enableHighAccuracy: true });
      } else {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimer() {
      const now = Date.now();
      elapsedSeconds = Math.floor((now - startTime) / 1000);
      const minutes = Math.floor(elapsedSeconds / 60);
      const seconds = elapsedSeconds % 60;

      let miles = totalDistance / METERS_IN_MILE;
      let pace = miles > 0 ? elapsedSeconds / 60 / miles : 0;
      let remaining = (3 - miles) * pace; // estimate for 3 miles

      const paceText = pace.toFixed(2);
      const estFinish = remaining > 0 ? `${Math.floor(remaining)}:${Math.floor((remaining % 1) * 60).toString().padStart(2, '0')}` : "0:00";
      statsDisplay.innerText = `Time: ${minutes}:${seconds.toString().padStart(2, '0')} | Pace: ${paceText} min/mile | Est. Finish: ${estFinish}`;
    }

    function updateLocation(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      if (lastPosition) {
        const d = calcDistance(lat, lon, lastPosition.lat, lastPosition.lon);
        totalDistance += d;
      }
      lastPosition = { lat, lon };
    }

    function calcDistance(lat1, lon1, lat2, lon2) {
      const R = 6371e3; // metres
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }
  </script>
</body>
</html>
